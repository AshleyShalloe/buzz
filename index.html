<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzz</title>
    <style>
        :root {
            --styloGold: #cebea7;
        }

        html {
            font-family: sans-serif;
            background: #e6e7e8;
        }

        body {
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-content: center;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
            padding-bottom: 30px;
        }

        .key {
            fill: var(--styloGold) !important;
            stroke: black;
            stroke-width: 3;
            width: 100px;
            height: 170px;
        }

        .key.keyBlack {
            height: 87.5px;
        }

        .keyLabel {
            font-size: 30px;
            font-weight: bold;
            text-anchor: middle;
            font-family: sans-serif;
        }
    </style>
</head>

<body>
    Press space to play.
    <svg width="1500" height="400" xmlns="http://www.w3.org/2000/svg">
        <g>
            <g>
                <rect class="key keyWhite" id="key1" x="10" y="100" />
                <rect class="key keyWhite" id="key2" x="110" y="100" />
                <rect class="key keyWhite" id="key3" x="210" y="100" />
                <rect class="key keyWhite" id="key4" x="310" y="100" />
                <rect class="key keyWhite" id="key5" x="410" y="100" />
                <rect class="key keyWhite" id="key6" x="510" y="100" />
                <rect class="key keyWhite" id="key7" x="610" y="100" />
                <rect class="key keyWhite" id="key8" x="710" y="100" />
                <rect class="key keyWhite" id="key9" x="810" y="100" />
                <rect class="key keyWhite" id="key10" x="910" y="100" />
                <rect class="key keyWhite" id="key11" x="1010" y="100" />
                <rect class="key keyWhite" id="key12" x="1110" y="100" />
            </g>
            <g>
                <polygon class="key keyBlack" id="key1_5" points="60,100 60,170 75,187.5 145,187.5 160,170 160,100" />
                <polygon class="key keyBlack" id="key3_5" points="260,100 260,170 275,187.5 345,187.5 360,170 360,100" />
                <polygon class="key keyBlack" id="key4_5" points="360,100 360,170 375,187.5 445,187.5 460,170 460,100" />
                <polygon class="key keyBlack" id="key6_5" points="560,100 560,170 575,187.5 645,187.5 660,170 660,100" />
                <polygon class="key keyBlack" id="key7_5" points="660,100 660,170 675,187.5 745,187.5 760,170 760,100" />
                <polygon class="key keyBlack" id="key8_5" points="760,100 760,170 775,187.5 845,187.5 860,170 860,100" />
                <polygon class="key keyBlack" id="key10_5" points="960,100 960,170 975,187.5 1045,187.5 1060,170 1060,100" />
                <polygon class="key keyBlack" id="key11_5" points="1060,100 1060,170 1075,187.5 1145,187.5 1160,170 1160,100" />
            </g>
        </g>
        <g>
            <g>
                <text class="keyLabel" x="55" y="310">1</text>
                <text class="keyLabel" x="155" y="310">2</text>
                <text class="keyLabel" x="255" y="310">3</text>
                <text class="keyLabel" x="355" y="310">4</text>
                <text class="keyLabel" x="455" y="310">5</text>
                <text class="keyLabel" x="555" y="310">6</text>
                <text class="keyLabel" x="655" y="310">7</text>
                <text class="keyLabel" x="755" y="310">8</text>
                <text class="keyLabel" x="855" y="310">9</text>
                <text class="keyLabel" x="955" y="310">10</text>
                <text class="keyLabel" x="1055" y="310">11</text>
                <text class="keyLabel" x="1155" y="310">12</text>
            </g>
            <g>
                <text class="keyLabel" x="110" y="85">1.5</text>
                <text class="keyLabel" x="310" y="85">3.5</text>
                <text class="keyLabel" x="410" y="85">4.5</text>
                <text class="keyLabel" x="610" y="85">6.5</text>
                <text class="keyLabel" x="710" y="85">7.5</text>
                <text class="keyLabel" x="810" y="85">8.5</text>
                <text class="keyLabel" x="1010" y="85">10.5</text>
                <text class="keyLabel" x="1110" y="85">11.5</text>
            </g>
        </g>
    </svg>

</body>
<script>
    'use strict'

    function playNoteByName(noteName) {
        `
        Plays a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Assumes you have an audio context called audioCtx
        `
        var noteFrequency = getFrequencyFromNoteName(noteName)
        var oscillator = audioCtx.createOscillator();
        oscillator.type = waveform ? waveform : "sine";
        oscillator.frequency.setValueAtTime(noteFrequency, audioCtx.currentTime); // value in hertz

        oscillator.connect(mainGainNode);
        oscillator.start();
        playingOscArray.push(oscillator)
    }

    function stopAllOsc() {
        playingOscArray.forEach(x => x.stop())
    }

    function getFrequencyFromNoteName(noteName) {
        `
        Gets frequency in Hz for a note given a name, e.g. A4 or C♯3
        Will let you get away with using # instead of ♯
        Breaks above G#9 because of the assumption that the octave is always a single digit
        `
        var note = noteName.slice(0, noteName.length - 1).replace("#", "♯")
        var octave = parseInt(noteName.slice(noteName.length - 1))
        var noteIdx = chromaticScale.indexOf(note)

        var noteValueRelativeToA4 = noteIdx + (12 * (octave - 4))
        var noteFrequency = (2 ** (noteValueRelativeToA4 / 12)) * 440

        return noteFrequency
    }

    function initKeyEvents() {
        var keyElms = document.getElementsByClassName("keyWhite")

        for (var i = 0; i < keyElms.length; i++) {
            var note = chromaticScaleWhite[i % chromaticScaleWhite.length]
            var elm = keyElms[i]
            var octave = Math.floor(i / chromaticScaleWhite.length) + 4
            elm.dataset.note = `${note}${octave}`
            elm.onmouseenter = function () {
                stopAllOsc();
                playNoteByName(this.dataset.note)
            }
        }

        var keyElms = document.getElementsByClassName("keyBlack")

        for (var i = 0; i < keyElms.length; i++) {
            var note = chromaticScaleBlack[i % chromaticScaleBlack.length]
            var elm = keyElms[i]
            var octave = Math.floor(i / chromaticScaleBlack.length) + 4
            elm.dataset.note = `${note}${octave}`
            elm.onmouseenter = function () {
                stopAllOsc();
                playNoteByName(this.dataset.note)
            }
        }
    }

    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mainGainNode = audioCtx.createGain();
            mainGainNode.connect(audioCtx.destination);
            mainGainNode.gain.value = 0.15;
        }
    }

    window.addEventListener("keydown", (e) => {
        initAudioContext()
        switch (e.key) {
            case " ":
                e.preventDefault()
                mainGainNode.gain.value = 0.15
                break
        }
    });

    window.addEventListener("keyup", (e) => {
        switch (e.key) {
            case " ":
                e.preventDefault()
                mainGainNode.gain.value = 0
                break
        }
    });

    // globals
    const chromaticScale = ["A", "A♯", "B", "C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯"]
    const chromaticScaleWhite = ["A", "B", "C", "D", "E", "F", "G"]
    const chromaticScaleBlack = ["A♯", "C♯", "D♯", "F♯", "G♯"]
    var audioCtx
    var mainGainNode
    var waveform = "square"
    var stepDuration = 0.2
    var playingOscArray = []

    // init
    function init() {
        initKeyEvents()
    }

    init();

</script>

</html>